<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Turbo Chatwoot Webhook - Admin Panel</title>
    
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    
    <!-- Custom CSS -->
    <style>
        .wrapper {
            height: 100vh !important;
        }
        .main-sidebar {
            height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
        }
        .content-wrapper {
            margin-left: 250px !important;
            min-height: 100vh !important;
            padding-left: 0 !important;
        }
        .main-header {
            position: fixed !important;
            top: 0 !important;
            right: 0 !important;
            left: 250px !important;
            z-index: 1030 !important;
            margin-left: 0 !important;
            padding-left: 0 !important;
        }
        .content {
            margin-top: 70px !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
            padding-bottom: 60px !important; /* Space for fixed footer */
        }
        
        /* Fixed footer at bottom of viewport */
        .main-footer {
            position: fixed !important;
            bottom: 0 !important;
            left: 250px !important;
            right: 0 !important;
            z-index: 1000 !important;
            width: calc(100% - 250px) !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            text-align: center !important;
        }
        
        /* Custom styles for 2-level menu */
        .nav-treeview {
            padding-left: 1rem;
        }
        .nav-treeview .nav-link {
            padding-left: 1.5rem;
            font-size: 0.9rem;
        }
        .nav-treeview .nav-link i {
            font-size: 0.8rem;
        }
        .nav-item.has-treeview > .nav-link .right {
            transition: transform 0.3s ease;
        }
        .nav-item.has-treeview.menu-open > .nav-link .right {
            transform: rotate(-90deg);
        }
        .nav-item.has-treeview > .nav-link:hover .right {
            transform: rotate(-45deg);
        }
        .nav-item.has-treeview.menu-open > .nav-link:hover .right {
            transform: rotate(-90deg);
        }

        /* Menu cha active - màu trắng */
        .nav-item.has-treeview > .nav-link.active {
            background-color: #fff !important;
            color: #007bff !important;
        }

        /* Menu con active - màu xanh */
        .nav-treeview .nav-link.active {
            background-color: #007bff !important;
            color: #fff !important;
        }

        /* Hover effects */
        .nav-item.has-treeview > .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-treeview .nav-link:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        @media (max-width: 767.98px) {
            .content-wrapper {
                margin-left: 0 !important;
            }
            .main-header {
                left: 0 !important;
            }
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
    <div id="app"></div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Vue Router 4 -->
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    
    <!-- Services -->
    <script src="/admin/src/services/BaseService.js"></script>
    <script src="/admin/src/services/AuthService.js"></script>
    <script src="/admin/src/services/AdminService.js"></script>
    <script src="/admin/src/services/TelegramService.js"></script>
    <script src="/admin/src/services/ChatwootService.js"></script>
    <script src="/admin/src/services/DifyService.js"></script>
    <script src="/admin/src/services/UserService.js"></script>
    <script src="/admin/src/services/ConfigurationService.js"></script>
    <script src="/admin/src/services/LogsService.js"></script>
    <script src="/admin/src/services/index.js"></script>
    
    <!-- Utils -->
    <script src="/admin/src/utils/auth.js"></script>
    
    <!-- Components -->
    <script src="/admin/src/pages/LoginPage.js"></script>
    
        <!-- Module Components will be loaded dynamically -->

    <!-- Vue Components will be loaded dynamically -->

    <script>
        const { createApp } = Vue;
        const { createRouter, createWebHistory } = VueRouter;

        // Simple Vue SFC loader
        async function loadVueComponent(path) {
            try {
                const response = await fetch(path);
                const text = await response.text();
                
                // Parse template, script, and style sections
                const templateMatch = text.match(/<template>([\s\S]*?)<\/template>/);
                const scriptMatch = text.match(/<script>([\s\S]*?)<\/script>/);
                const styleMatch = text.match(/<style[^>]*>([\s\S]*?)<\/style>/);
                
                const template = templateMatch ? templateMatch[1].trim() : '';
                const scriptContent = scriptMatch ? scriptMatch[1].trim() : '';
                
                // Create component object
                const component = {
                    template: template
                };
                
                // Parse script content - improved regex
                if (scriptContent) {
                    // Remove export default and get the object
                    let cleanScript = scriptContent.replace(/export\s+default\s*/, '').trim();
                    if (cleanScript.endsWith(';')) {
                        cleanScript = cleanScript.slice(0, -1);
                    }
                    
                    try {
                        const scriptObj = new Function('return ' + cleanScript)();
                        Object.assign(component, scriptObj);
                    } catch (e) {
                        console.error('Error parsing script for', path, e);
                        // Fallback: try to extract just the object part
                        const objMatch = cleanScript.match(/\{[\s\S]*\}/);
                        if (objMatch) {
                            const scriptObj = new Function('return ' + objMatch[0])();
                            Object.assign(component, scriptObj);
                        }
                    }
                }
                
                return component;
            } catch (error) {
                console.error('Failed to load Vue component:', path, error);
                return null;
            }
        }
        
        // Load Vue components
        let SidebarComponent, HeaderComponent, AdminLayoutComponent, ListComponent, PageComponent;
        let DashboardPageComponent, UsersPageComponent, ConfigurationsPageComponent, LogsPageComponent;
        let ChatwootAccountsListComponent, DifyAppsListComponent, TelegramBotsListComponent;
        let FormListingSortComponent, FormTableFiltersComponent, FormCheckBoxComponent, PaginateComponent, ActionButtonsComponent;
        
        async function loadComponents() {
            console.log('🔄 Loading Vue components...');
            
            // Load main components
            SidebarComponent = await loadVueComponent('/admin/src/components/SidebarComponent.vue');
            console.log('SidebarComponent loaded:', !!SidebarComponent);
            window.SidebarComponent = SidebarComponent;
            
            HeaderComponent = await loadVueComponent('/admin/src/components/HeaderComponent.vue');
            console.log('HeaderComponent loaded:', !!HeaderComponent);
            window.HeaderComponent = HeaderComponent;
            
            AdminLayoutComponent = await loadVueComponent('/admin/src/components/AdminLayoutComponent.vue');
            console.log('AdminLayoutComponent loaded:', !!AdminLayoutComponent);
            window.AdminLayoutComponent = AdminLayoutComponent;
            
            ListComponent = await loadVueComponent('/admin/src/components/ListComponent.vue');
            console.log('ListComponent loaded:', !!ListComponent);
            window.ListComponent = ListComponent;
            
            PageComponent = await loadVueComponent('/admin/src/components/PageComponent.vue');
            console.log('PageComponent loaded:', !!PageComponent);
            window.PageComponent = PageComponent;
            
            // Load module components
            DashboardPageComponent = await loadVueComponent('/admin/src/modules/dashboard/DashboardPageComponent.vue');
            console.log('DashboardPageComponent loaded:', !!DashboardPageComponent);
            window.DashboardPageComponent = DashboardPageComponent;
            
            UsersPageComponent = await loadVueComponent('/admin/src/modules/users/UsersPageComponent.vue');
            console.log('UsersPageComponent loaded:', !!UsersPageComponent);
            window.UsersPageComponent = UsersPageComponent;
            
            ConfigurationsPageComponent = await loadVueComponent('/admin/src/modules/configurations/ConfigurationsPageComponent.vue');
            console.log('ConfigurationsPageComponent loaded:', !!ConfigurationsPageComponent);
            window.ConfigurationsPageComponent = ConfigurationsPageComponent;
            
            LogsPageComponent = await loadVueComponent('/admin/src/modules/logs/LogsPageComponent.vue');
            console.log('LogsPageComponent loaded:', !!LogsPageComponent);
            window.LogsPageComponent = LogsPageComponent;
            
            // Load additional components
            ChatwootAccountsListComponent = await loadVueComponent('/admin/src/modules/chatwoot/ChatwootAccountsListComponent.vue');
            console.log('ChatwootAccountsListComponent loaded:', !!ChatwootAccountsListComponent);
            window.ChatwootAccountsListComponent = ChatwootAccountsListComponent;
            
            DifyAppsListComponent = await loadVueComponent('/admin/src/modules/dify/DifyAppsListComponent.vue');
            console.log('DifyAppsListComponent loaded:', !!DifyAppsListComponent);
            window.DifyAppsListComponent = DifyAppsListComponent;
            
            TelegramBotsListComponent = await loadVueComponent('/admin/src/modules/telegram/TelegramBotsListComponent.vue');
            console.log('TelegramBotsListComponent loaded:', !!TelegramBotsListComponent);
            window.TelegramBotsListComponent = TelegramBotsListComponent;
            
            // Load shared components
            FormListingSortComponent = await loadVueComponent('/admin/src/components/shared/FormListingSortComponent.vue');
            console.log('FormListingSortComponent loaded:', !!FormListingSortComponent);
            window.FormListingSortComponent = FormListingSortComponent;
            
            FormTableFiltersComponent = await loadVueComponent('/admin/src/components/shared/FormTableFiltersComponent.vue');
            console.log('FormTableFiltersComponent loaded:', !!FormTableFiltersComponent);
            window.FormTableFiltersComponent = FormTableFiltersComponent;
            
            FormCheckBoxComponent = await loadVueComponent('/admin/src/components/shared/FormCheckBoxComponent.vue');
            console.log('FormCheckBoxComponent loaded:', !!FormCheckBoxComponent);
            window.FormCheckBoxComponent = FormCheckBoxComponent;
            
            PaginateComponent = await loadVueComponent('/admin/src/components/shared/PaginateComponent.vue');
            console.log('PaginateComponent loaded:', !!PaginateComponent);
            window.PaginateComponent = PaginateComponent;
            
            ActionButtonsComponent = await loadVueComponent('/admin/src/components/shared/ActionButtonsComponent.vue');
            console.log('ActionButtonsComponent loaded:', !!ActionButtonsComponent);
            window.ActionButtonsComponent = ActionButtonsComponent;
            
            console.log('✅ All components loaded and registered globally');
        }


        // Initialize app
        async function initializeApp() {
            try {
                // Load Vue components first
                await loadComponents();
                
                // Create router with loaded components
                const router = createRouter({
                    history: createWebHistory(),
                    routes: [
            { path: '/admin/login', component: window.LoginPage },
            {
                path: '/admin',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', redirect: '/admin/dashboard' }
                ]
            },
            {
                path: '/admin/dashboard',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.DashboardPageComponent }
                ]
            },
            {
                path: '/admin/users',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.UsersPageComponent }
                ]
            },
            {
                path: '/admin/roles',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.PageComponent }
                ]
            },
            {
                path: '/admin/telegram-bots',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.TelegramBotsListComponent }
                ]
            },
            {
                path: '/admin/chatwoot-accounts',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.ChatwootAccountsListComponent }
                ]
            },
            {
                path: '/admin/dify-apps',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.DifyAppsListComponent }
                ]
            },
            {
                path: '/admin/configurations',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.ConfigurationsPageComponent }
                ]
            },
            {
                path: '/admin/logs',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.LogsPageComponent }
                ]
            },
            { path: '/', redirect: '/admin/login' },
            { path: '/admin/:pathMatch(.*)*', redirect: '/admin/login' }
                    ]
        });

        // Set up router guard
        router.beforeEach((to, from, next) => {
            const token = localStorage.getItem('token');
            const isLoginPage = to.path === '/admin/login';
            const isAdminRoot = to.path === '/admin' || to.path === '/admin/';
            const isAdminRoute = to.path.startsWith('/admin');
            
            if (!token) {
                if (isLoginPage) {
                    next();
                } else if (isAdminRoute) {
                    next('/admin/login');
                } else {
                    next('/admin/login');
                }
            } else {
                if (isLoginPage) {
                    next('/admin/dashboard');
                } else if (isAdminRoot) {
                    next('/admin/dashboard');
                } else {
                    next();
                }
            }
        });

        // Main App
        const app = createApp({
            template: '<router-view></router-view>',
            data() {
                return {
                    isLoading: false
                }
            },
            mounted() {
                const token = localStorage.getItem('token');
                if (token) {
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                }
            }
        });

        app.use(router);
        
        // Wait for all services to load, then mount
                const allServicesLoaded = window.BaseService && window.AuthService && 
                                        window.TelegramService && window.ChatwootService && 
                                        window.DifyService && window.UserService && 
                                        window.ConfigurationService && window.LogsService;
                
                if (!allServicesLoaded) {
                    console.error('❌ Not all services loaded, cannot mount app');
                    return;
                }
                
                app.mount('#app');
                
                const currentPath = window.location.pathname;
                router.replace(currentPath).then(() => {
                }).catch(error => {
                    console.error('❌ Router navigation failed:', error);
                });
                
            } catch (error) {
                console.error('❌ Failed to initialize app:', error);
            }
        }
        
        // Start the app
        initializeApp();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Turbo Chatwoot Webhook - Admin Panel</title>
    
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    
    <!-- Custom CSS -->
    <style>
        .wrapper {
            height: 100vh !important;
        }
        .main-sidebar {
            height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
        }
        .content-wrapper {
            margin-left: 250px !important;
            min-height: 100vh !important;
            padding-left: 0 !important;
        }
        .main-header {
            position: fixed !important;
            top: 0 !important;
            right: 0 !important;
            left: 250px !important;
            z-index: 1030 !important;
            margin-left: 0 !important;
            padding-left: 0 !important;
        }
        .content {
            margin-top: 70px !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
            padding-bottom: 60px !important; /* Space for fixed footer */
        }
        
        /* Fixed footer at bottom of viewport */
        .main-footer {
            position: fixed !important;
            bottom: 0 !important;
            left: 250px !important;
            right: 0 !important;
            z-index: 1000 !important;
            width: calc(100% - 250px) !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            text-align: center !important;
        }
        
        /* Custom styles for 2-level menu */
        .nav-treeview {
            padding-left: 1rem;
        }
        .nav-treeview .nav-link {
            padding-left: 1.5rem;
            font-size: 0.9rem;
        }
        .nav-treeview .nav-link i {
            font-size: 0.8rem;
        }
        .nav-item.has-treeview > .nav-link .right {
            transition: transform 0.3s ease;
        }
        .nav-item.has-treeview.menu-open > .nav-link .right {
            transform: rotate(-90deg);
        }
        .nav-item.has-treeview > .nav-link:hover .right {
            transform: rotate(-45deg);
        }
        .nav-item.has-treeview.menu-open > .nav-link:hover .right {
            transform: rotate(-90deg);
        }

        /* Menu cha active - màu trắng */
        .nav-item.has-treeview > .nav-link.active {
            background-color: #fff !important;
            color: #007bff !important;
        }

        /* Menu con active - màu xanh */
        .nav-treeview .nav-link.active {
            background-color: #007bff !important;
            color: #fff !important;
        }

        /* Hover effects */
        .nav-item.has-treeview > .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-treeview .nav-link:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        @media (max-width: 767.98px) {
            .content-wrapper {
                margin-left: 0 !important;
            }
            .main-header {
                left: 0 !important;
            }
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
    <div id="app"></div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Vue Router 4 -->
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    
    <!-- Vuelidate -->
    <script src="https://unpkg.com/@vuelidate/core@2.0.0-alpha.33/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@vuelidate/validators@2.0.0-alpha.22/dist/index.umd.js"></script>
    
    <!-- Lodash -->
    <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>
    
    <!-- Services -->
    <script src="/admin/src/services/BaseService.js"></script>
    <script src="/admin/src/services/AuthService.js"></script>
    <script src="/admin/src/services/AdminService.js"></script>
    <script src="/admin/src/services/TelegramService.js"></script>
    <script src="/admin/src/services/ChatwootService.js"></script>
    <script src="/admin/src/services/DifyService.js"></script>
    <script src="/admin/src/services/UserService.js"></script>
    <script src="/admin/src/services/ConfigurationService.js"></script>
    <script src="/admin/src/services/LogsService.js"></script>
    <script src="/admin/src/services/index.js"></script>
    
    <!-- Utils -->
    <script src="/admin/src/utils/auth.js"></script>
    
    <!-- Components -->
    <script src="/admin/src/pages/LoginPage.js"></script>
    
        <!-- Module Components will be loaded dynamically -->

    <!-- Vue Components will be loaded dynamically -->

    <script>
        const { createApp } = Vue;
        const { createRouter, createWebHistory } = VueRouter;

        // Enhanced Vue SFC loader for Vue 3.5.21
        async function loadVueComponent(path) {
            try {
                const response = await fetch(path);
                const text = await response.text();
                
                // Parse template, script, and style sections
                const templateMatch = text.match(/<template[^>]*>([\s\S]*?)<\/template>/);
                const scriptMatch = text.match(/<script[^>]*>([\s\S]*?)<\/script>/);
                const styleMatch = text.match(/<style[^>]*>([\s\S]*?)<\/style>/);
                
                const template = templateMatch ? templateMatch[1].trim() : '';
                const scriptContent = scriptMatch ? scriptMatch[1].trim() : '';
                
                // Create component object
                const component = {
                    template: template
                };
                
                // Parse script content with better error handling
                if (scriptContent) {
                    try {
                        // Remove export default and clean up
                        let cleanScript = scriptContent.replace(/export\s+default\s*/, '').trim();
                        
                        // Remove trailing semicolon if present
                        if (cleanScript.endsWith(';')) {
                            cleanScript = cleanScript.slice(0, -1);
                        }
                        
                        // Handle object literal syntax
                        if (cleanScript.startsWith('{') && cleanScript.endsWith('}')) {
                            // Direct object literal
                            const scriptObj = new Function('return ' + cleanScript)();
                            Object.assign(component, scriptObj);
                        } else {
                            // Try to extract object from more complex syntax
                            const objMatch = cleanScript.match(/\{[\s\S]*\}/);
                            if (objMatch) {
                                const scriptObj = new Function('return ' + objMatch[0])();
                                Object.assign(component, scriptObj);
                            } else {
                                console.warn('Could not parse script content for', path);
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing script for', path, e);
                        console.error('Script content:', scriptContent.substring(0, 200) + '...');
                        
                        // Try fallback parsing
                        try {
                            // Look for the main object definition
                            const objMatch = scriptContent.match(/\{[\s\S]*\}/);
                            if (objMatch) {
                                const scriptObj = new Function('return ' + objMatch[0])();
                                Object.assign(component, scriptObj);
                            }
                        } catch (fallbackError) {
                            console.error('Fallback parsing also failed for', path, fallbackError);
                        }
                    }
                }
                
                return component;
            } catch (error) {
                console.error('Failed to load Vue component:', path, error);
                return null;
            }
        }
        
        // Load Vue components
        let SidebarComponent, HeaderComponent, AdminLayoutComponent, ListComponent, PageComponent;
        let DashboardPageComponent, UsersPageComponent, UserListComponent, UserFormComponent, UserPasswordFormComponent, ConfigurationsPageComponent, LogsPageComponent;
        let ChatwootAccountsListComponent, DifyAppsListComponent, TelegramBotsListComponent;
        let FormListingSortComponent, FormTableFiltersComponent, FormCheckBoxComponent, PaginateComponent, ActionButtonsComponent;
        let FormInputTextComponent, FormImageComponent, FormSelectComponent, FormInputDateComponent;
        
        async function loadComponents() {
            
            // Load main components first
            SidebarComponent = await loadVueComponent('/admin/src/components/SidebarComponent.vue');
            window.SidebarComponent = SidebarComponent;
            
            HeaderComponent = await loadVueComponent('/admin/src/components/HeaderComponent.vue');
            window.HeaderComponent = HeaderComponent;
            
            AdminLayoutComponent = await loadVueComponent('/admin/src/components/AdminLayoutComponent.vue');
            window.AdminLayoutComponent = AdminLayoutComponent;
            
            ListComponent = await loadVueComponent('/admin/src/components/ListComponent.vue');
            window.ListComponent = ListComponent;
            
            PageComponent = await loadVueComponent('/admin/src/components/PageComponent.vue');
            window.PageComponent = PageComponent;
            
            // Load user sub-components FIRST (before UsersPageComponent)
            UserListComponent = await loadVueComponent('/admin/src/modules/users/UserListComponent.vue');
            window.UserListComponent = UserListComponent;
            
            UserFormComponent = await loadVueComponent('/admin/src/modules/users/UserFormComponent.vue');
            window.UserFormComponent = UserFormComponent;
            
            // Load UserPasswordFormComponent
            UserPasswordFormComponent = await loadVueComponent('/admin/src/modules/users/UserPasswordFormComponent.vue');
            window.UserPasswordFormComponent = UserPasswordFormComponent;
            
            // Load module components (after sub-components are loaded)
            DashboardPageComponent = await loadVueComponent('/admin/src/modules/dashboard/DashboardPageComponent.vue');
            window.DashboardPageComponent = DashboardPageComponent;
            
            UsersPageComponent = await loadVueComponent('/admin/src/modules/users/UsersPageComponent.vue');
            window.UsersPageComponent = UsersPageComponent;
            
            ConfigurationsPageComponent = await loadVueComponent('/admin/src/modules/configurations/ConfigurationsPageComponent.vue');
            window.ConfigurationsPageComponent = ConfigurationsPageComponent;
            
            LogsPageComponent = await loadVueComponent('/admin/src/modules/logs/LogsPageComponent.vue');
            window.LogsPageComponent = LogsPageComponent;
            
            // Load additional components
            ChatwootAccountsListComponent = await loadVueComponent('/admin/src/modules/chatwoot/ChatwootAccountsListComponent.vue');
            window.ChatwootAccountsListComponent = ChatwootAccountsListComponent;
            
            DifyAppsListComponent = await loadVueComponent('/admin/src/modules/dify/DifyAppsListComponent.vue');
            window.DifyAppsListComponent = DifyAppsListComponent;
            
            TelegramBotsListComponent = await loadVueComponent('/admin/src/modules/telegram/TelegramBotsListComponent.vue');
            window.TelegramBotsListComponent = TelegramBotsListComponent;
            
            // Load shared components
            FormListingSortComponent = await loadVueComponent('/admin/src/components/shared/FormListingSortComponent.vue');
            window.FormListingSortComponent = FormListingSortComponent;
            
            FormTableFiltersComponent = await loadVueComponent('/admin/src/components/shared/FormTableFiltersComponent.vue');
            window.FormTableFiltersComponent = FormTableFiltersComponent;
            
            FormCheckBoxComponent = await loadVueComponent('/admin/src/components/shared/FormCheckBoxComponent.vue');
            window.FormCheckBoxComponent = FormCheckBoxComponent;
            
            PaginateComponent = await loadVueComponent('/admin/src/components/shared/PaginateComponent.vue');
            window.PaginateComponent = PaginateComponent;
            
            ActionButtonsComponent = await loadVueComponent('/admin/src/components/shared/ActionButtonsComponent.vue');
            window.ActionButtonsComponent = ActionButtonsComponent;
            
            // Load shared form components
            FormInputTextComponent = await loadVueComponent('/admin/src/components/shared/FormInputTextComponent.vue');
            window.FormInputTextComponent = FormInputTextComponent;
            
            FormImageComponent = await loadVueComponent('/admin/src/components/shared/FormImageComponent.vue');
            window.FormImageComponent = FormImageComponent;
            
            FormSelectComponent = await loadVueComponent('/admin/src/components/shared/FormSelectComponent.vue');
            window.FormSelectComponent = FormSelectComponent;
            
            FormInputDateComponent = await loadVueComponent('/admin/src/components/shared/FormInputDateComponent.vue');
            window.FormInputDateComponent = FormInputDateComponent;
        }


        // Initialize app
        async function initializeApp() {
            try {
                // Load Vue components first
                await loadComponents();
                
                // Create router with loaded components
                const router = createRouter({
                    history: createWebHistory(),
                    routes: [
            { path: '/admin/login', component: window.LoginPage },
            {
                path: '/admin',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', redirect: '/admin/dashboard' }
                ]
            },
            {
                path: '/admin/dashboard',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.DashboardPageComponent }
                ]
            },
            {
                path: '/admin/users',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.UsersPageComponent }
                ]
            },
            {
                path: '/admin/roles',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.PageComponent }
                ]
            },
            {
                path: '/admin/telegram-bots',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.TelegramBotsListComponent }
                ]
            },
            {
                path: '/admin/chatwoot-accounts',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.ChatwootAccountsListComponent }
                ]
            },
            {
                path: '/admin/dify-apps',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.DifyAppsListComponent }
                ]
            },
            {
                path: '/admin/configurations',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.ConfigurationsPageComponent }
                ]
            },
            {
                path: '/admin/logs',
                component: window.AdminLayoutComponent,
                children: [
                    { path: '', component: window.LogsPageComponent }
                ]
            },
            { path: '/', redirect: '/admin/login' },
            { path: '/admin/:pathMatch(.*)*', redirect: '/admin/login' }
                    ]
        });

        // Set up router guard
        router.beforeEach((to, from, next) => {
            const token = localStorage.getItem('token');
            const isLoginPage = to.path === '/admin/login';
            const isAdminRoot = to.path === '/admin' || to.path === '/admin/';
            const isAdminRoute = to.path.startsWith('/admin');
            
            if (!token) {
                if (isLoginPage) {
                    next();
                } else if (isAdminRoute) {
                    next('/admin/login');
                } else {
                    next('/admin/login');
                }
            } else {
                if (isLoginPage) {
                    next('/admin/dashboard');
                } else if (isAdminRoot) {
                    next('/admin/dashboard');
                } else {
                    next();
                }
            }
        });

        // Main App
        const app = createApp({
            template: '<router-view></router-view>',
            data() {
                return {
                    isLoading: false
                }
            },
            mounted() {
                const token = localStorage.getItem('token');
                if (token) {
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                }
            }
        });

        // Register dependencies globally
        function registerDependencies() {
            // Register Vuelidate
            if (window.Vuelidate) {
                window.useVuelidate = window.Vuelidate.useVuelidate;
            }
            if (window.VuelidateValidators) {
                window.required = window.VuelidateValidators.required;
                window.email = window.VuelidateValidators.email;
                window.minLength = window.VuelidateValidators.minLength;
            }
            
            // Register Lodash
            if (window._) {
                window.lodash = window._;
            }
            
        }

        // Register all components globally
        function registerGlobalComponents() {
            if (window.SidebarComponent) app.component('SidebarComponent', window.SidebarComponent);
            if (window.HeaderComponent) app.component('HeaderComponent', window.HeaderComponent);
            if (window.AdminLayoutComponent) app.component('AdminLayoutComponent', window.AdminLayoutComponent);
            if (window.ListComponent) app.component('ListComponent', window.ListComponent);
            if (window.PageComponent) app.component('PageComponent', window.PageComponent);
            if (window.DashboardPageComponent) app.component('DashboardPageComponent', window.DashboardPageComponent);
            if (window.UsersPageComponent) app.component('UsersPageComponent', window.UsersPageComponent);
            if (window.UserListComponent) app.component('UserListComponent', window.UserListComponent);
            if (window.UserFormComponent) app.component('UserFormComponent', window.UserFormComponent);
            if (window.UserPasswordFormComponent) app.component('UserPasswordFormComponent', window.UserPasswordFormComponent);
            if (window.ConfigurationsPageComponent) app.component('ConfigurationsPageComponent', window.ConfigurationsPageComponent);
            if (window.LogsPageComponent) app.component('LogsPageComponent', window.LogsPageComponent);
            if (window.ChatwootAccountsListComponent) app.component('ChatwootAccountsListComponent', window.ChatwootAccountsListComponent);
            if (window.DifyAppsListComponent) app.component('DifyAppsListComponent', window.DifyAppsListComponent);
            if (window.TelegramBotsListComponent) app.component('TelegramBotsListComponent', window.TelegramBotsListComponent);
            if (window.FormListingSortComponent) app.component('FormListingSortComponent', window.FormListingSortComponent);
            if (window.FormTableFiltersComponent) app.component('FormTableFiltersComponent', window.FormTableFiltersComponent);
            if (window.FormCheckBoxComponent) app.component('FormCheckBoxComponent', window.FormCheckBoxComponent);
            if (window.PaginateComponent) app.component('PaginateComponent', window.PaginateComponent);
            if (window.ActionButtonsComponent) app.component('ActionButtonsComponent', window.ActionButtonsComponent);
            if (window.FormInputTextComponent) app.component('FormInputTextComponent', window.FormInputTextComponent);
            if (window.FormImageComponent) app.component('FormImageComponent', window.FormImageComponent);
            if (window.FormSelectComponent) app.component('FormSelectComponent', window.FormSelectComponent);
            if (window.FormInputDateComponent) app.component('FormInputDateComponent', window.FormInputDateComponent);
        }

        app.use(router);
        
        // Register dependencies first
        registerDependencies();
        
        // Register components globally
        registerGlobalComponents();
        
        // Wait for all services to load, then mount
                const allServicesLoaded = window.BaseService && window.AuthService && 
                                        window.TelegramService && window.ChatwootService && 
                                        window.DifyService && window.UserService && 
                                        window.ConfigurationService && window.LogsService;
                
                if (!allServicesLoaded) {
                    console.error('❌ Not all services loaded, cannot mount app');
                    return;
                }
                
                app.mount('#app');
                
                const currentPath = window.location.pathname;
                router.replace(currentPath).then(() => {
                }).catch(error => {
                    console.error('❌ Router navigation failed:', error);
                });
                
            } catch (error) {
                console.error('❌ Failed to initialize app:', error);
            }
        }
        
        // Start the app
        initializeApp();
    </script>
</body>
</html>